apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "swanlab.next.fullname" . }}
  labels:
  {{- include "swanlab.next.labels" . | nindent 4 }}
spec:
  replicas: {{ default 0 .Values.service.next.replicas }}
  selector:
    matchLabels:
    {{- include "swanlab.next.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
      {{- include "swanlab.next.labels" . | nindent 8 }}
      {{- include "swanlab.next.selectorLabels" . | nindent 8 }}
      {{- if .Values.service.next.customAnnotations }}
      annotations:
      {{- toYaml .Values.service.next.customAnnotations | nindent 8 }}
      {{- end }}
    spec:
      restartPolicy: Always
      imagePullSecrets:
      {{- include "swanlab.imagePullSecrets" . | nindent 8 }}
      initContainers:
        - name: ping
          env:
            - name: SWANLAB_SERVER_URL
              value: "http://{{ include "swanlab.server.fullname" . }}:{{ include "swanlab.server.port" . }}/api"
            - name: SWANLAB_CLOUD_URL
              value: "http://{{ include "swanlab.cloud.fullname" . }}:{{include "swanlab.cloud.port" . }}"
            - name: SWANLAB_HOUSE_URL
              value: "http://{{ include "swanlab.house.fullname" . }}:{{include "swanlab.house.port" . }}/api/house"
          image: {{ .Values.helper.repository }}:{{ .Values.helper.tag }}
          imagePullPolicy: {{ .Values.helper.pullPolicy }}
          command: [ "/bin/sh", "-c" ]
          args:
            - |
              # Function to parse HTTP URL and check TCP connectivity
              check_url() {
                service_name=$1
                url=$2

                if [ -z "$url" ]; then
                  echo "‚ö™ $service_name URL not set, skipping check."
                  return
                fi

                # --- URL Parsing ---
                # 1. Remove protocol (http:// or https://)
                tmp="${url#*://}"
                # 2. Remove path suffix (e.g., /api, /, or query params)
                tmp="${tmp%%/*}"

                # 3. Extract Host and Port
                # Get content before the last colon
                host="${tmp%:*}"
                # Get content after the last colon
                port="${tmp##*:}"

                # If host equals port, it means no port was specified in URL (e.g. http://example.com/api)
                # Default to 80 in that case
                if [ "$host" = "$port" ]; then
                  port="80"
                fi

                # --- Check Logic ---
                echo "‚û°Ô∏è  Checking $service_name ($host:$port)..."
                until nc -z -w 1 "$host" "$port"; do
                  echo "   ‚è≥ Waiting for $service_name to be ready..."
                  sleep 2
                done
                echo "‚úÖ $service_name is ready!"
              }

              echo "üîç Starting service connectivity check..."

              # Check SwanLab Server (removes /api automatically)
              check_url "SwanLab Server" "$SWANLAB_SERVER_URL"

              # Check SwanLab Cloud
              check_url "SwanLab Cloud" "$SWANLAB_CLOUD_URL"

              # Check SwanLab House (removes /api/house automatically)
              check_url "SwanLab House" "$SWANLAB_HOUSE_URL"

              echo "üéâ All services are reachable!"
      containers:
        - name: server
          image: {{ include "swanlab.next.image" . | quote }}
          imagePullPolicy: {{ .Values.service.next.image.pullPolicy }}
          ports:
            - containerPort: 3000
              name: web
          env:
            - name: CLOUD_URL
              value: "http://{{ include "swanlab.cloud.fullname" . }}:{{include "swanlab.cloud.port" . }}"
            - name: API_URL
              value: "http://{{ include "swanlab.gateway.fullname" . }}:80/api"
            - name: API_VERIFIER_URL
              value: {{ include "swanlab.server.identify" . | quote }}
            - name: API_INTERNAL_URL
              value: "http://{{ include "swanlab.gateway.fullname" . }}:80/api"
            {{- $loginHost := .Values.global.settings.loginHost }}
            {{- if $loginHost | ne "" }}
            - name: API_DISPLAY_HOST
              value: {{ $loginHost | quote }}
            {{- end }}
        {{- if .Values.service.next.resources }}
          resources:
        {{- toYaml .Values.service.next.resources | nindent 12 }}
        {{- end }}
      {{- if .Values.service.next.customNodeSelector }}
      nodeSelector:
      {{- toYaml .Values.service.next.customNodeSelector | nindent 8 }}
      {{- end }}
      {{- if .Values.service.next.customTolerations }}
      tolerations:
      {{- toYaml .Values.service.next.customTolerations | nindent 8 }}
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "swanlab.next.fullname" . }}
  labels:
  {{- include "swanlab.next.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  selector:
  {{- include "swanlab.next.selectorLabels" . | nindent 4 }}
  ports:
    - port: {{ include "swanlab.next.port" . }}
      targetPort: web
