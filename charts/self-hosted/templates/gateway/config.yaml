apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "swanlab.gateway.configmap" . }}
data:
  # -------------------------
  # Static configuration (loaded at startup)
  # -------------------------
  traefik.yaml: |
    global:
      checkNewVersion: false
      sendAnonymousUsage: false
    log:
      level: INFO
    # 定义入口点
    entryPoints:
      web:
        address: ":80"
    #    for s3 upload files
        forwardedHeaders:
          insecure: true
      traefik:
        address: ":8080"
      metrics:
        address: ":9100"
    # File Provider
    providers:
      file:
        directory: "/etc/traefik/dynamic"
        watch: true # Hot reload
    experimental:
      localPlugins:
        identify:
          moduleName: github.com/swanhubx/swanlab-helper/identify
{{/*    api:*/}}
{{/*      dashboard: true # UI*/}}
{{/*      insecure: true  # API*/}}

  # -------------------------
  # Dynamic Configuration (Routing Rules)
  # -------------------------
  {{- $host := "" }}
  {{- $cluster := include "swanlab.clusterDomain" . }}
  {{- $namespace := .Release.Namespace }}
  {{- $next := include "swanlab.next.fullname" . }}
  {{- $nextPort := include "swanlab.next.port" . }}
  {{- $server := include "swanlab.server.fullname" . }}
  {{- $serverPort := include "swanlab.server.port" .}}
  {{- $house := include "swanlab.house.fullname" . }}
  {{- $housePort := include "swanlab.house.port" . }}
  {{- $s3 := include "swanlab.s3.fullname" . }}
  {{- $s3Port := include "swanlab.s3.minio.port" . }}
  dynamic.yaml: |
    http:
      middlewares:
        {{ include "swanlab.gateway.identify" . }}:
          plugin:
            identify:
              AuthUrl: {{ include "swanlab.server.identify" . | quote }}
        {{- if .Values.integrations.s3.enabled | eq false }}
        {{ include "swanlab.gateway.s3" . }}:
          headers:
            customRequestHeaders:
    #          No need to use cluster DNS
              Host: {{ printf "%s:%s" $s3 $s3Port | quote }}
        {{- end }}
      routers:
        next-router:
          rule: {{ include "swanlab.gateway.match" (list $host "/") }}
          service: "swanlab-next"
          entryPoints:
            - "web"
        server-router:
          rule: {{ include "swanlab.gateway.match" (list $host "/api") }}
          service: "swanlab-server"
          entryPoints:
            - "web"
          middlewares: [{{ include "swanlab.gateway.identify" . }}]
        house-router:
          rule: {{ include "swanlab.gateway.match" (list $host "/api/house") }}
          service: "swanlab-house"
          entryPoints:
            - "web"
          middlewares: [{{ include "swanlab.gateway.identify" . }}]
        server-router-internal:
    #      rule: PathPrefix(`/api`) && Header(`X-Requested-By`, `swanlab-next`)
          rule: PathPrefix(`/api`)
          service: "swanlab-server"
          entryPoints:
            - "web"
          middlewares: [{{ include "swanlab.gateway.identify" . }}]
        house-router-internal:
    #      rule: PathPrefix(`/api/house`) && Header(`X-Requested-By`, `swanlab-next`)
          rule: PathPrefix(`/api/house`)
          service: "swanlab-house"
          entryPoints:
            - "web"
          middlewares: [{{ include "swanlab.gateway.identify" . }}]
      {{- if .Values.integrations.s3.enabled | eq false }}
        s3-router:
          {{- $s1 := include "swanlab.gateway.match" (list $host "/swanlab-private")}}
          {{- $s2 := include "swanlab.gateway.match" (list $host "/swanlab-public")}}
          rule: {{ printf "(%s) || (%s)" $s1 $s2 }}
          service: "swanlab-s3"
          entryPoints:
            - "web"
          middlewares: [{{ include "swanlab.gateway.s3" . }}]
      {{- end }}

      services:
        # Define Backend Service
        # Note: The full DNS name of the K8s Service must be used here
        # Format: <service-name>.<namespace>.svc.cluster.local
        swanlab-next:
          loadBalancer:
            servers:
              - url: {{ include "swanlab.gateway.url" (list $next $namespace $cluster $nextPort) }}
        swanlab-server:
          loadBalancer:
            servers:
              - url: {{ include "swanlab.gateway.url" (list $server $namespace $cluster $serverPort) }}
        swanlab-house:
          loadBalancer:
            servers:
              - url: {{ include "swanlab.gateway.url" (list $house $namespace $cluster $housePort) }}
        {{- if .Values.integrations.s3.enabled | eq false }}
        swanlab-s3:
          loadBalancer:
            servers:
              - url: {{ include "swanlab.gateway.url" (list $s3 $namespace $cluster $s3Port) }}
        {{- end }}

