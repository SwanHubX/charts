name: 'Helm Chart Release'

#on:
#  # ç›‘å¬ 'release' äº‹ä»¶
#  release:
#    # ä»…å½“å‘å¸ƒè¢«å‘å¸ƒï¼ˆpublishedï¼‰æ—¶è§¦å‘
#    types:
#      - published

# å…è®¸åŒæ—¶è¿è¡Œä¸€ä¸ªä½œä¸šï¼Œå¹¶å–æ¶ˆæ—§çš„ä½œä¸š
concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  # æ£€æŸ¥å¹¶å‘å¸ƒ chart çš„ä½œä¸š
  release:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è·å–å®Œæ•´çš„ Git å†å²ï¼Œä»¥ä¾¿ chart-releaser èƒ½å¤Ÿç”Ÿæˆæ­£ç¡®çš„ index æ–‡ä»¶
          fetch-depth: 0

      # è‡ªåŠ¨è®¾ç½® Chart.yaml ç‰ˆæœ¬
      - name: âš™ï¸ Set Chart Version from Tag
        id: setup-version
        # ç¡®ä¿ä½ çš„ Git Tag æ ¼å¼ä¸º 'vX.Y.Z'
        run: |
          # 1. å®‰è£… yq (ç”¨äºå¤„ç† YAML æ–‡ä»¶)
          # yq æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å‘½ä»¤è¡Œ YAML/JSON å¤„ç†å™¨
          echo "Installing yq..."
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          
          # 2. è·å– Tag ç‰ˆæœ¬
          TAG_VERSION=${GITHUB_REF##*/}
          # ç§»é™¤å‰ç¼€ 'v' (ä¾‹å¦‚ v1.2.3 -> 1.2.3)
          NEW_VERSION=${TAG_VERSION#v}
          
          CHART_PATH="./traefik-proxy"
          
          # 3. æ£€æŸ¥ Tag æ ¼å¼æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ SemVerï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
          if ! echo "$NEW_VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' ; then
            echo "::error::Git Tag '$TAG_VERSION' (stripped to '$NEW_VERSION') is not a valid Semantic Version (X.Y.Z). Aborting."
            exit 1
          fi
          
          # 4. ä½¿ç”¨ yq æ›´æ–° Chart.yaml ä¸­çš„ version å­—æ®µ
          echo "Updating $CHART_PATH/Chart.yaml version to $NEW_VERSION..."
          yq e ".version = \"$NEW_VERSION\"" -i $CHART_PATH/Chart.yaml
                    
          # 6. æ‰“å°æ›´æ–°åçš„ç‰ˆæœ¬ä»¥ä¾›æ£€æŸ¥
          UPDATED_VERSION=$(yq e '.version' $CHART_PATH/Chart.yaml)
          echo "Successfully updated Chart.yaml version to: $UPDATED_VERSION"
          
          # 7. ä½œä¸ºOUTPUTSè¾“å‡ºç‰ˆæœ¬ä»¥ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT


      # è¿›è¡Œ Helm Lint æ£€æŸ¥
      - name: ğŸ› ï¸ Set up Helm
        # helm v3.18+
        uses: azure/setup-helm@v4.3.0

      - name: ğŸ” Run Helm Lint
        run: |
          HELM_CHART_PATH="./traefik-proxy" 
          
          if [ ! -d "$HELM_CHART_PATH" ]; then
            echo "Error: Helm chart directory not found at $HELM_CHART_PATH"
            exit 1
          fi
          
          # æ‰§è¡Œ helm lintï¼Œ-s æ ‡å¿—ä¼šè·³è¿‡ values.yaml ä¸­ç¼ºå¤±çš„ keys è­¦å‘Š
          echo "Running helm lint on $HELM_CHART_PATH..."
          helm lint $HELM_CHART_PATH

      # ä½¿ç”¨åŸç”Ÿhelmå‘½ä»¤æ¨é€chartåˆ°ä»“åº“
      - name: ğŸš€ Release Helm Chart
        env:
          HELM_CHAT_FILE: "traefik-proxy-${{steps.setup-version.outputs.version}}.tgz"
        run: |
          helm plugin install https://github.com/AliyunContainerService/helm-acr
          helm repo add traefik https://helm.traefik.io/traefik
          helm repo update
          cd traefik-proxy
          helm dependency build .
          helm package .
          echo "${{ secrets.SWANLAB_HELM_REPO_PASSWORD }}" | helm registry login repo.swanlab.cn \
            -u ${{ secrets.SWANLAB_HELM_REPO_USERNAME }} \
            --password-stdin
          helm push $HELM_CHAT_FILE oci://repo.swanlab.cn/helm

